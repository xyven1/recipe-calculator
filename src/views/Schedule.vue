<template>
  <v-container class="fill-height flex-column align-start ga-4" fluid>
    <v-btn @click="addScheduleItem(ScheduleItem())" color="primary">
      Add Schedule
    </v-btn>
    <div
      class="w-100"
      style="
        --grid-layout-gap: 10px;
        --grid-column-count: 8;
        --grid-item--min-width: 400px;

        --gap-count: calc(var(--grid-column-count) - 1);
        --total-gap-width: calc(var(--gap-count) * var(--grid-layout-gap));
        --grid-item--max-width: calc(
          (100% - var(--total-gap-width)) / var(--grid-column-count)
        );

        display: grid;
        grid-template-columns: repeat(
          auto-fill,
          minmax(
            max(var(--grid-item--min-width), var(--grid-item--max-width)),
            1fr
          )
        );
        grid-gap: var(--grid-layout-gap);
      "
    >
      <v-card
        v-for="scheduleItem in schedule.sort(
          (a, b) => new Date(a.date).getTime() - new Date(b.date).getTime()
        )"
        :key="scheduleItem.id"
        elevation="4"
      >
        <v-card-title>
          {{ new Date(scheduleItem.date).toLocaleDateString() }} -
          {{ recipes.find((v) => v.id === scheduleItem.recipeID)?.name }}
        </v-card-title>
        <v-card-text class="d-flex flex-column ga-2">
          <v-autocomplete
            auto-select-first
            :items="recipes"
            item-title="name"
            item-value="id"
            hide-details="auto"
            density="compact"
            v-model="scheduleItem.recipeID"
          />
          <v-text-field
            v-model="scheduleItem.people"
            type="number"
            label="people"
            hide-details="auto"
            density="compact"
          />
          <v-expansion-panels color="tonal">
            <v-expansion-panel color="tonal">
              <v-expansion-panel-title :expand-icon="mdiPencil">
                Date
              </v-expansion-panel-title>
              <v-expansion-panel-text class="justify-center">
                <v-date-picker
                  :model-value="new Date(scheduleItem.date)"
                  @update:model-value="
                    (v) => {
                      console.log(v);
                      scheduleItem.date = v.toISOString();
                    }
                  "
                />
              </v-expansion-panel-text>
            </v-expansion-panel>
          </v-expansion-panels>
        </v-card-text>
        <v-card-actions>
          <v-btn
            @click="addScheduleItem(scheduleItem)"
            color="success"
            variant="tonal"
          >
            Save
          </v-btn>
          <v-btn
            @click="removeScheduleItem(scheduleItem)"
            color="error"
            variant="tonal"
          >
            Delete
          </v-btn>
        </v-card-actions>
      </v-card>
    </div>
  </v-container>
</template>

<script lang="ts" setup>
import {
  DatabaseData,
  GroceryStatus,
  Recipe,
  ScheduleItem,
} from "@/types/recipe";
import { mdiPencil } from "@mdi/js";
import { ref as dbRef, push, remove, set } from "firebase/database";
import { useDatabase, useDatabaseList } from "vuefire";
const db = useDatabase();
const schedule = useDatabaseList<ScheduleItem>(dbRef(db, "schedule"));
const ingredients = useDatabaseList<ScheduleItem>(dbRef(db, "ingredients"));
const recipes = useDatabaseList<Recipe>(dbRef(db, "recipes"));
const groceryStatuses = useDatabaseList<GroceryStatus>(
  dbRef(db, "groceryStatus")
);

function addScheduleItem(
  scheduleItem: DatabaseData<ScheduleItem> | ScheduleItem
) {
  if ("id" in scheduleItem) {
    set(dbRef(db, "schedule/" + scheduleItem.id), scheduleItem);
    // Remove entries in the "groceryStatus" collection where scheduleItemId matches
    console.log(scheduleItem.id);

    set(
      dbRef(db, "groceryStatus"),
      groceryStatuses.value.filter((v) => v.scheduleItemID !== scheduleItem.id)
    );

    for (const i of recipes.value.find((v) => v.id === scheduleItem.recipeID)
      ?.ingredients || []) {
      let groceryStatus = GroceryStatus(scheduleItem.id);
      groceryStatus.date = scheduleItem.date;
      groceryStatus.ingredientID = i.ingredientID;
      groceryStatus.assignee = "Jacob"; // TODO: set to currently authenticated user

      push(dbRef(db, "groceryStatus/"), groceryStatus);
    }
  } else push(dbRef(db, "schedule"), scheduleItem);
}
function removeScheduleItem(
  scheduleItem: ScheduleItem & {
    readonly id: string;
  }
) {
  if ("id" in scheduleItem) {
    remove(dbRef(db, "schedule/" + scheduleItem.id));
    let statuses = groceryStatuses.value.filter(
      (v) => v.scheduleItemID === scheduleItem.id
    );
    for (const status of statuses) {
      remove(dbRef(db, "groceryStatus/" + status.id));
    }
  }
}
</script>
